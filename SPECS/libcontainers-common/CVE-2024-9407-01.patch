From 3e9cb7432d5a90731b7cde9eeea924e1b76633f9 Mon Sep 17 00:00:00 2001
From: Nick Samson <nisamson@microsoft.com>
Date: Mon, 14 Oct 2024 17:25:37 -0700
Subject: [PATCH] Added fix for CVE-2024-9407

---
 pkg/specgenutil/volumes.go  | 6 ++++++
 test/e2e/run_volume_test.go | 4 ++++
 2 files changed, 10 insertions(+)

diff --git a/pkg/specgenutil/volumes.go b/pkg/specgenutil/volumes.go
index b9a85f18b..d971a8ce5 100644
--- a/pkg/specgenutil/volumes.go
+++ b/pkg/specgenutil/volumes.go
@@ -271,6 +271,12 @@ func parseMountOptions(mountType string, args []string) (*spec.Mount, error) {
 			if len(kv) == 1 {
 				return nil, fmt.Errorf("%v: %w", kv[0], errOptionArg)
 			}
+			switch kv[1] {
+			case "shared", "rshared", "private", "rprivate", "slave", "rslave", "unbindable", "runbindable":
+				// Do nothing, sane value
+			default:
+				return nil, fmt.Errorf("invalid value %q", val)
+			}
 			mnt.Options = append(mnt.Options, kv[1])
 		case "consistency":
 			// Often used on MACs and mistakenly on Linux platforms.
diff --git a/test/e2e/run_volume_test.go b/test/e2e/run_volume_test.go
index 1a900053f..671a9c356 100644
--- a/test/e2e/run_volume_test.go
+++ b/test/e2e/run_volume_test.go
@@ -99,6 +99,10 @@ var _ = Describe("Podman run with volumes", func() {
 		session.WaitWithDefaultTimeout()
 		Expect(session).To(ExitWithError())
 
+		session = podmanTest.Podman([]string{"run", "--rm", "--mount=type=bind,src=/tmp,target=/tmp,bind-propagation=fake", ALPINE, "true"})
+		session.WaitWithDefaultTimeout()
+		Expect(session).To(ExitWithError())
+
 		// test csv escaping
 		session = podmanTest.Podman([]string{"run", "--rm", "--mount=type=tmpfs,tmpfs-size=512M,\"destination=/test,\"", ALPINE, "ls", "/test,"})
 		session.WaitWithDefaultTimeout()
-- 
2.34.1

